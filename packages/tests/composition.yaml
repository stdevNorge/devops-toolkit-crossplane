apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: test-k6
spec:
  compositeTypeRef:
    apiVersion: apdexone.com/v1alpha1
    kind: XTest
  resources:
  - name: kubernetes
    base:
      apiVersion: kubernetes.crossplane.io/v1alpha1
      kind: ProviderConfig
      spec:
        credentials:
          source: InjectedIdentity
    patches:
    - fromFieldPath: spec.id
      toFieldPath: metadata.name
    readinessChecks:
      - type: None
  - name: cronjob
    base:
      apiVersion: kubernetes.crossplane.io/v1alpha1
      kind: Object
      spec:
        forProvider:
          manifest:
            apiVersion: batch/v1
            kind: CronJob
            spec:
              jobTemplate:
                spec:
                  template:
                    spec:
                      containers:
                      - imagePullPolicy: Always
                        env:
                        - name: K6_PROMETHEUS_REMOTE_URL
                          value: "http://monitoring-prometheus-server.monitoring.svc/api/v1/write"
                      restartPolicy: OnFailure
    patches:
    - fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
        - type: string
          string:
            fmt: "%s-cronjob"
    - fromFieldPath: spec.parameters.namespace
      toFieldPath: metadata.namespace
    - fromFieldPath: spec.parameters.namespace
      toFieldPath: spec.forProvider.manifest.metadata.namespace
    - fromFieldPath: spec.id
      toFieldPath: spec.forProvider.manifest.metadata.name
      transforms:
        - type: string
          string:
            fmt: "%s-cronjob"
    - fromFieldPath: spec.id
      toFieldPath: spec.providerConfigRef.name
    - fromFieldPath: spec.parameters.schedule
      toFieldPath: spec.forProvider.manifest.spec.schedule
    - fromFieldPath: spec.parameters.image
      toFieldPath: spec.forProvider.manifest.spec.jobTemplate.spec.template.spec.containers[0].image
    - fromFieldPath: spec.id
      toFieldPath: spec.forProvider.manifest.spec.jobTemplate.spec.template.spec.containers[0].name
    - fromFieldPath: spec.parameters.args
      toFieldPath: spec.forProvider.manifest.spec.jobTemplate.spec.template.spec.containers[0].args
    - fromFieldPath: spec.parameters.cpu
      toFieldPath: spec.forProvider.manifest.spec.jobTemplate.spec.template.spec.containers[0].resources.requests.cpu
    - fromFieldPath: spec.parameters.memory
      toFieldPath: spec.forProvider.manifest.spec.jobTemplate.spec.template.spec.containers[0].resources.requests.memory
    - fromFieldPath: spec.parameters.pods
      toFieldPath: spec.forProvider.manifest.spec.jobTemplate.spec.completions
    - fromFieldPath: spec.parameters.pods
      toFieldPath: spec.forProvider.manifest.spec.jobTemplate.spec.parallelism
    - fromFieldPath: spec.parameters.duration
      toFieldPath: spec.forProvider.manifest.spec.jobTemplate.spec.activeDeadlineSeconds
